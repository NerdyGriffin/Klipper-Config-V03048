[include mainsail.cfg]
[include moonraker_obico_macros.cfg]
[include timelapse.cfg]
# This file contains common pin mappings for the BIGTREETECH SKR Pico V1.0
# To use this config, the firmware should be compiled for the RP2040 with
# USB communication.

# The "make flash" command does not work on the SKR Pico V1.0. Instead,
# after running "make", copy the generated "out/klipper.uf2" file
# to the mass storage device in RP2040 boot mode

## Voron Design VORON 0.2 SKR Pico V1.0 config

## *** THINGS TO CHANGE/CHECK: ***
## MCU path                                                                     [mcu] section
## Z and Extruder motor currents                                                [tmc2209 stepper_*] sections. Uncomment the stepper motor you have
## Full steps per rotation for Extruder                                         [extruder] section
## Thermistor types                                                             [extruder] and [heater_bed] sections - See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types
## Motor currents                                                               [extruder] [stepper] and [_HOME_X/Y] macro sections
## PID tune                                                                     [extruder] and [heater_bed] sections
## Fine tune E steps                                                            [extruder] section
## For more info                                                                check https://docs.vorondesign.com/build/startup/#v0

[mcu]
serial: /dev/serial/by-id/usb-Klipper_rp2040_45503571290DBB58-if00
restart_method: command


[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000 # Input shaper recommended max x: 18290 max y: 8200
max_z_velocity: 50          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 300
minimum_cruise_ratio: 0
# square_corner_velocity: 5.0

[include autotune.cfg]

#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: gpio11
## Refer to https://docs.vorondesign.com/build/startup/#v0
dir_pin: !gpio10                                                     # Check motor direction in link above. If inverted, add a ! before gpio10
enable_pin: !gpio12
rotation_distance: 40
microsteps: 64
full_steps_per_rotation: 200                                        # Set to 400 for 0.9° degree stepper motor, 200 is for 1.8° stepper motors
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: 120
position_max: 120
homing_speed: 120                                                    # for sensorless homing with tmc autotune homing_speed should be numerically greater than rotation_distance
homing_retract_dist: 0
homing_retract_speed: 160
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 0
interpolate: true
run_current: 1.0
sense_resistor: 0.110
diag_pin: ^gpio4                                                    # YOU NEED TO JUMP THIS DIAG PIN ON YOUR BOARD FOR SENSORLESS HOMING TO WORK
# driver_SGTHRS: 60 # Klipper TMC Autotune overrides this setting     # this is set to 255 which is the MAX sensitivity for sensorless homing, you will need to tune this later

[stepper_y]
step_pin: gpio6
## Refer to https://docs.vorondesign.com/build/startup/#v0
dir_pin: !gpio5                                                      # Check motor direction in link above. If inverted, add a ! before gpio5
enable_pin: !gpio7
rotation_distance: 40
microsteps: 64
full_steps_per_rotation: 200                                        # Set to 400 for 0.9° degree stepper motor, 200 is for 1.8° stepper motors
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 120
position_max: 120
homing_speed: 120                                                    # for sensorless homing with tmc autotune homing_speed should be numerically greater than rotation_distance
homing_retract_dist: 0
homing_retract_speed: 160
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 2
interpolate: true
run_current: 1.0
sense_resistor: 0.110
diag_pin: ^gpio3                                                    # YOU NEED TO JUMP THIS DIAG PIN ON YOUR BOARD FOR SENSORLESS HOMING TO WORK
# driver_SGTHRS: 60 # Klipper TMC Autotune overrides this setting     # this is set to 255 which is the MAX sensitivity for sensorless homing, you will need to tune this later

#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: gpio19
dir_pin: gpio28                                                    # Remove the ! before gpio28 if motor direction is inverted.
enable_pin: !gpio2
rotation_distance: 8                                                # For T8x8 integrated lead screw
microsteps: 64
endstop_pin: ^gpio25
#position_endstop: 120
position_max: 120
position_min: -1.5
homing_speed: 8 # Recommended 10 for PZ Probe
homing_retract_speed: 50
second_homing_speed: 4 # Equal to probe.speed # Proportional to rotation_distance
homing_retract_dist: 4
homing_positive_dir: true

[tmc2209 stepper_z]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 1
interpolate: true
## For OMC (StepperOnline) 17LS13-0404E-200G 0.4A
run_current: 0.2
## For LDO-42STH25-1004CL200E 1.0A
#run_current: 0.37
sense_resistor: 0.110

#####################################################################
#   Extruder
#####################################################################

[extruder]
# 2024 Motor Model: LDO 36STH20-1004AHG(XH)
step_pin: nhk:gpio23                                                # LDO Nitehawk overrides this setting
dir_pin: !nhk:gpio24                                                # LDO Nitehawk overrides this setting
enable_pin: !nhk:gpio25                                             # LDO Nitehawk overrides this setting
full_steps_per_rotation: 200                                        # Set to 200 for LDO 1.8° stepper motor, and set to 400 for OMC(StepperOnline) 0.9° stepper motor
# Note: a higher rotation_distance value means that less filament is being extruded.
# rotation_distance: 22.40                                            # See calibrating rotation_distance on extruders doc.
# rotation_distance: 47.088 #Galileo 2 16mm Drive Gear
rotation_distance: 47.088 # Calibrated 2025-09-17
# gear_ratio: 50:10                                                   # For Mini Afterburner
gear_ratio: 9:1                                                     # For Galileo 2
microsteps: 16
nozzle_diameter: 0.500
filament_diameter: 1.750
heater_pin: nhk:gpio9                                               # LDO Nitehawk overrides this setting
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for NTC 100k 3950 thermistors
sensor_type: PT1000
sensor_pin: nhk:gpio29                                              # LDO Nitehawk overrides this setting
#control: pid                                                        # Do PID calibration after initial checks
#pid_Kp: 28.182
#pid_Ki: 1.978
#pid_Kd: 100.397
min_temp: 10
max_temp: 310                                                       # Default: 270
min_extrude_temp: 170
max_extrude_only_distance: 150
max_extrude_cross_section: 5                                        # Required for KAMP
max_extrude_only_velocity: 120
# Default = ( 16 * printer.toolhead.max_velocity * ( nozzle_diameter^2 ) )
#             /
#           ( pi * ( filament_diameter^2 ) )
##  Try to keep pressure_advance below 1.0
# pressure_advance: 0.02 # Tuned 2023
pressure_advance: 0.03 # Tuned 2025
pressure_advance_smooth_time: 0.02 # Recommended 2025-02-19

[tmc2209 extruder]
uart_pin: nhk:gpio0                                                 # LDO Nitehawk overrides this setting
tx_pin: nhk:gpio1                                                   # LDO Nitehawk overrides this setting
interpolate: true                                                   # LDO Nitehawk overrides this setting
run_current: 0.6 # 0.6 for Galileo 2
sense_resistor: 0.110                                               # LDO Nitehawk overrides this setting

# Workaround for 2024-06 heating issues.
#[verify_heater extruder]
#max_error: 240 # default 120

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: gpio21
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for Keenovo heaters
sensor_type: ATC Semitec 104GT-2
sensor_pin: gpio26
smooth_time: 3.0
#max_power: 0.6                                                     # Only needed for 100w pads
min_temp: 0
max_temp: 120                                                       # Default: 120
#control: pid                                                        # Do PID calibration after initial checks
#pid_kp: 68.453
#pid_ki: 2.749
#pid_kd: 426.122

#####################################################################
#   Probe
#####################################################################

# [probe]
# ##  Revo PZ Probe
# pin: !nhk:gpio10                                                     # LDO Nitehawk overrides this setting
# x_offset: 0
# y_offset: 0
# #z_offset: 0
# #z_offset 2024-05-22 ABS: 13.530
# #z_offset 2024-05-22 Nylon: 13.510
# #z_offset 2024-06-04 Nylon: 13.470
# #z_offset 2024-06-06 PLA: 13.510
# #z_offset 2024-06-19 PLA: 13.490
# #z_offset 2024-07-18 Nylon: 13.405
# #z_offset 2024-07-25 PLA: 13.480
# #z_offset 2024-08-02 ABS: 13.540
# #z_offset 2024-12-09 PETG: 13.530
# #z_offset 2024-12-12 TPU: 13.410
# #z_offset 2024-12-18 ABS: 13.530
# #z_offset 2025-02-07 ABS: 13.560 # Toolhead rebuild
# #z_offset = -0.085 # Revo PZ
# speed: 8 # default: 5.0 # Equal to stepper_z.second_homing_speed # Proportional to rotation_distance
# lift_speed: 50
# samples: 3
# samples_result: median
# sample_retract_dist: 5 # default: 2.0
# samples_tolerance: 0.01
# samples_tolerance_retries: 10

# activate_gcode:
#     {% set PROBE_TEMP = 150 %}
#     {% set MAX_TEMP = PROBE_TEMP + 5 %}
#     {% set ACTUAL_TEMP = printer.extruder.temperature %}
#     {% set TARGET_TEMP = printer.extruder.target %}

#     {% if TARGET_TEMP > PROBE_TEMP %}
#         { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#         M117 { 'Cooling to %.1fC...' % (PROBE_TEMP) }
#         M109 S{ PROBE_TEMP }
#         M117 Probing...
#     {% elif ACTUAL_TEMP > MAX_TEMP %}
#         # Temperature target is already low enough, but nozzle may still be too hot.
#         { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#         M117 { 'Waiting until temperature is below %.1fC...' % (MAX_TEMP) }
#         TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#         M117 Probing...
#     {% endif %}

#     M400 ; wait for buffer to clear
#     UPDATE_DELAYED_GCODE ID=RESET_RUN_CURRENT_Z DURATION=0

#     # Set current for Revo PZ probe homing
#     {% set RUN_CURRENT_Z = printer.configfile.settings['tmc2209 stepper_z'].run_current|float %}
#     {% set HOME_CURRENT_Z = 0.1 %}
#     SET_TMC_CURRENT STEPPER=stepper_z CURRENT={HOME_CURRENT_Z}
#     G4 P200
# deactivate_gcode:
#     M400 ; wait for buffer to clear
#     UPDATE_DELAYED_GCODE ID=RESET_RUN_CURRENT_Z DURATION=2

# [delayed_gcode RESET_RUN_CURRENT_Z]
# gcode:
#     M400 ; wait for buffer to clear
#     UPDATE_DELAYED_GCODE ID=RESET_RUN_CURRENT_Z DURATION=0

#     # Set current during print
#     {% set RUN_CURRENT_Z = printer.configfile.settings['tmc2209 stepper_z'].run_current|float %}
#     SET_TMC_CURRENT STEPPER=stepper_z CURRENT={RUN_CURRENT_Z}
#     G4 P200

#####################################################################
#   Fan Control
#####################################################################

[fan]
##  Print Cooling Fan - Nitehawk PCF (Formerly FAN1)
pin: nhk:gpio6                                                      # LDO Nitehawk overrides this setting
kick_start_time: 0.5                                                # Depending on your fan, you may need to increase this value if your fan will not start
off_below: 0.10

[heater_fan hotend_fan]
##  Hotend Fan - Nitehawk HEF (Formerly FAN2)
pin: nhk:gpio5                                                      # LDO Nitehawk overrides this setting
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[heater_fan bed_fan]
##  Bed Heater Fan - FAN1
pin: gpio17
shutdown_speed: 0.0
kick_start_time: 0.5
heater: heater_bed
heater_temp: 40
fan_speed: 0.2

[controller_fan controller_fan]
##  Controller fan - FAN2
pin: gpio18
kick_start_time: 0.5
heater: heater_bed

[heater_fan filter_fan]
##  Nevermore filter fan - FAN3
pin: gpio20
shutdown_speed: 0.0
kick_start_time: 5.0
heater: extruder, heater_bed
heater_temp: 40
fan_speed: 0.2

#####################################################################
#   LED Control
#####################################################################

[neopixel bed_light]
## RGB light installed on bed mount
pin: gpio24
chain_count: 1
color_order: GRBW
initial_RED: 0.01
initial_GREEN: 0.01
initial_BLUE: 0.01
initial_WHITE: 1.0

# [neopixel camera_light]
# ## RGB light installed next to camera module
# pin: gpio29
# chain_count: 7
# color_order: GRBW
# initial_RED: 0.0
# initial_GREEN: 0.0
# initial_BLUE: 0.0
# initial_WHITE: 0.5

[include neopixel-placeholder.cfg]

# [include led-effects.cfg]

######################################################################
# Beeper
######################################################################

[include beeper.cfg]

#####################################################################
#   Filament Runout Sensor
#####################################################################

# [filament_switch_sensor switch_sensor]
# switch_pin: ^gpio16
# pause_on_runout: False
# runout_gcode:
#     {% if not printer.pause_resume.is_paused %}
#         PAUSE # [pause_resume] is required in printer.cfg
#     {% endif %}
#     M117 Filament runout (switch)
# insert_gcode:
#     M117 Filament inserted (switch)

[filament_motion_sensor encoder_sensor]
switch_pin: ^gpio16
detection_length: 20 ; This can be adjusted to your desired level of sensitivity. 10 is a recommended value to prevent flow dropoff false triggers. BTT default is 2.88. 2024 tune: 18
extruder: extruder
pause_on_runout: False ; This can be set to false to debug false positives putting the sensor in "monitor mode". The printer will not pause but it will run the runout_gcode below.
runout_gcode:
    {% if not printer.pause_resume.is_paused %}
        PAUSE # [pause_resume] is required in printer.cfg
    {% endif %}
    M117 Filament runout (encoder)
insert_gcode:
    M117 Filament inserted (encoder)

#####################################################################
#   Additional Sensors
#####################################################################

[temperature_sensor chamber]
## Chamber Temperature - TH0
## Use "Generic 3950" for NTC 100k 3950 thermistors
sensor_type: Generic 3950
sensor_pin: gpio27
min_temp: 0
max_temp: 100
gcode_id: chamber_th

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[include homing.cfg] # Must be placed before revo-pz-probe.cfg

[idle_timeout]
# Modified to not disable steppers (M84) on idle
gcode:
    M104 S0 # Turn off extruder, keep bed on
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
    {% if printer.pause_resume.is_paused or printer.virtual_sdcard.is_active %}
        {% if "xyz" in printer.toolhead.homed_axes %}
            # AFC_BRUSH
            # AFC_PARK
        {% endif %}
    {% else %}
        TURN_OFF_HEATERS
        M84
    {% endif %}
timeout: 1800

## To be used with BED_SCREWS_ADJUST
[bed_screws]
screw1: 60,5
screw1_name: front screw
screw2: 5,115
screw2_name: back left
screw3: 115,115
screw3_name: back right

## Use SCREWS_TILT_CALCULATE to perform assisted leveling
#### There is too much flex in the cantilever to measure the front screw for PZ Probe
# [include revo-pz-probe.cfg] # Must be placed after homing.cfg

# [include ./Klicky-Probe/klicky-probe.cfg] # Must be placed after homing.cfg
# [include ./Klicky-Probe/klicky-specific.cfg]                #place to put other configurations specific to your printer
# [include ./Klicky-Probe/klicky-variables.cfg]                #Required
# [include ./Klicky-Probe/klicky-macros.cfg]                   #Required
# # [include ./Klicky-Probe/klicky-bed-mesh-calibrate.cfg]      #bed mesh, requires klipper configuration
# [include ./Klicky-Probe/klicky-screws-tilt-calculate.cfg]   #help adjust bed screws automatically
# #[include ./Klicky-Probe/klicky-quad-gantry-level.cfg]       #level 4 Z motors
# #[include ./Klicky-Probe/klicky-z-tilt-adjust.cfg]           #level 2 or 3 Z motors

#####################################################################
#   Input Shaper
#####################################################################

[resonance_tester]
accel_chip: adxl345
probe_points:
    60, 60, 20
max_freq: 200
accel_per_hz: 100
hz_per_sec: 0.5
sweeping_accel: 400
sweeping_period: 0

[include shaketune.cfg]

#####################################################################
#   LDO Nitehawk
#####################################################################
[include nitehawk-36.cfg]

#####################################################################
#   Macros
#####################################################################

[delayed_gcode MACHINE_STARTUP]
initial_duration: 1
gcode:
    NW_RETRACT
    _STARTUP_BEEP

[include auto_pid.cfg]
[include heat_soak.cfg]
[include maintenance_macros.cfg]
[include nozzlewiper.cfg]
[include status-macros.cfg]
[include print_macros.cfg]           # PRINT_START & PRINT_END
[include filament_management.cfg]   # LOAD/UNLOAD/PURGE_FILAMENT + helpers
[include client_macros.cfg]         # Mainsail/Fluidd pause/resume hooks
[include utility_macros.cfg]        # Debug & maintenance helpers

# ===== Relocated to print_macros.cfg =====

# ===== Relocated to filament_management.cfg =====

# [gcode_macro M600]
# description: Filament change
# gcode:
#     {% set x_center = printer.toolhead.axis_maximum.x|float / 2.0 %}
#     {% set y_front = printer.toolhead.axis_minimum.y|float + 10 %}
#     PAUSE X={x_center} Y={y_front} Z_MIN=50
#     # Z_MIN will park the toolhead at a minimum of 50 mm above to bed to make it easier for you to swap filament.

# ===== Relocated to utility_macros.cfg =====
# [gcode_macro DEEP_CLEAN_NOZZLE]######################################
#   Override existing macros with new features
#####################################################################

[include rename_existing.cfg]

#####################################################################
#   Optional G-Code features
#####################################################################

[firmware_retraction]
retract_length: 0.8 # The default is 0 mm.
retract_speed: 30 # The default is 20 mm/s.
#unretract_extra_length: 0
unretract_speed: 30 # The default is 10 mm/s.

[force_move]
enable_force_move: True # Enable FORCE_MOVE and SET_KINEMATIC_POSITION extended G-Code commands

[gcode_arcs] # Enable support for gcode arc (G2/G3) commands

[respond] # Enable the "M118" and "RESPOND" extended commands.

[exclude_object] # Enable exclude_object module in Klipper

# ===== Relocated to client_macros.cfg =====

#####################################################################
#   Speed & Acceleration Testing
#####################################################################

[include TEST_SPEED.cfg]
[include SETTLE_BELT_TENSION.cfg]

#####################################################################
#   Machine Shutdown
#####################################################################

[include shutdown.cfg]

#####################################################################
#   Auto Save Config
#####################################################################

[include save_config.cfg]

#####################################################################
#   Klipper Adaptive Meshing & Purging
#####################################################################

[include KAMP_Settings.cfg]
#[include ./KAMP/Adaptive_Meshing.cfg]       # Include to enable adaptive meshing configuration.
[include ./KAMP/Line_Purge.cfg]             # Include to enable adaptive line purging configuration.
#[include ./KAMP/Voron_Purge.cfg]            # Include to enable adaptive Voron logo purging configuration.
[include ./KAMP/Smart_Park.cfg]             # Include to enable the Smart Park function, which parks the printhead near the print area for final heating.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [stepper_z]
#*# position_endstop = 112.510
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.711
#*# pid_ki = 1.239
#*# pid_kd = 123.248
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 68.964
#*# pid_ki = 1.031
#*# pid_kd = 1153.429
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 75.8
#*# damping_ratio_x = 0.061
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.0
#*# damping_ratio_y = 0.035
